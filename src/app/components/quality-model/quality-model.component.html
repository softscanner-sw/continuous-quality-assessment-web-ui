<div class="quality-container">
    <!-- Quality Model Title -->
    <h2>SoftScanner's Quality Mapping Model (SSQMM)</h2>

    <!-- Scrollable SVG Tree Visualization -->
    <div class="svg-container">
        <svg [attr.width]="svgWidth" [attr.height]="svgHeight">
            <g *ngFor="let node of topLevelNodes">
                <!-- Rectangular node representing a goal (keeps original style) -->
                <rect [attr.x]="node.x! - rectWidth / 2" [attr.y]="node.y! - rectHeight / 2" [attr.width]="rectWidth"
                    [attr.height]="rectHeight" rx="10" ry="10"
                    [attr.fill]="selectedGoals.includes(node.name) ? '#6c63ff' : '#ccc'">
                </rect>

                <!-- Node label with a Material icon button for details -->
                <foreignObject [attr.x]="node.x! - rectWidth / 2" [attr.y]="node.y! - rectHeight / 2"
                    [attr.width]="rectWidth" [attr.height]="rectHeight">
                    <div class="node-label">
                        <span class="node-name">{{ node.name }}</span>
                        <button mat-icon-button color="primary" (click)="showGoalDetails(node)"
                            matTooltip="View Details">
                            <mat-icon>info</mat-icon>
                        </button>
                    </div>
                </foreignObject>

                <!-- Expand/collapse icon (kept as text for now) -->
                <text [attr.x]="node.x! + rectWidth / 2 + 10" [attr.y]="node.y!" class="expand-icon"
                    (click)="toggleExpand(node)">
                    {{ node.expanded ? '▲' : '▼' }}
                </text>

                <!-- Contextual menu for child goals -->
                <foreignObject *ngIf="node.expanded" [attr.x]="node.x! - rectWidth / 2" [attr.y]="node.y! + 80"
                    [attr.width]="getContextualMenuWidth(node)" [attr.height]="getContextualMenuHeight(node)">
                    <div class="contextual-menu">
                        <mat-list>
                            <mat-list-item *ngFor="let child of node.children">
                                <div class="menu-content">
                                    <span class="menu-label">{{ child.name }}</span>
                                    <button mat-icon-button color="primary" (click)="showGoalDetails(child)"
                                        matTooltip="View Details">
                                        <mat-icon>info</mat-icon>
                                    </button>
                                    <ng-container *ngIf="child.children && child.children.length > 0">
                                        <button mat-icon-button color="accent" (click)="toggleExpand(child)"
                                            matTooltip="Expand/Collapse">
                                            <mat-icon>{{ child.expanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
                                        </button>
                                    </ng-container>
                                    <ng-container *ngIf="!child.children || child.children.length === 0">
                                        <mat-checkbox [checked]="selectedGoals.includes(child.name)"
                                            (click)="$event.stopPropagation()" (change)="toggleGoalSelection(child)">
                                        </mat-checkbox>
                                    </ng-container>
                                </div>
                            </mat-list-item>
                        </mat-list>
                    </div>
                </foreignObject>
            </g>
        </svg>
    </div>
</div>